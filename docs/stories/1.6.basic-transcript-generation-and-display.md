# Story 1.6: Basic Transcript Generation and Display

## Status

Done

## Story

**As a** business user,
**I want** formatted transcript с speaker labels и timestamps,
**so that** I can review transcription accuracy и identify speakers in my meeting recording.

## Acceptance Criteria

1. Transcript formatting с speaker labels ("Speaker 1:", "Speaker 2:") и timestamp markers
2. Basic transcript display page с scrollable content и speaker highlighting
3. Timestamp display in readable format (MM:SS или HH:MM:SS) aligned с audio segments
4. Speaker turn organization с clear visual separation between different speakers
5. Text formatting preservation for readability (paragraph breaks, punctuation)
6. Basic transcript validation против empty results или API errors
7. Character encoding handling для Kazakh Cyrillic и Russian text display
8. Simple transcript preview with first 500 characters для quick quality assessment

## Tasks / Subtasks

- [x] Create Transcript Formatting Service (AC: 1, 5)
  - [x] Implement TranscriptFormatter class in backend/app/services/transcript_formatter.py
  - [x] Add speaker label generation and formatting logic
  - [x] Create timestamp formatting utility functions (MM:SS and HH:MM:SS)
  - [x] Handle paragraph breaks and text formatting preservation
  - [x] Add unit tests for formatting functions
- [x] Build Transcript Display Route and Controller (AC: 2, 6, 8)
  - [x] Create GET /jobs/{job_id}/transcript endpoint in backend/app/routes/jobs.py
  - [x] Add transcript validation logic для empty or error results
  - [x] Implement transcript preview generation (first 500 characters)
  - [x] Add error handling for missing or invalid job IDs
  - [x] Create response schema for transcript data
- [x] Implement Frontend Transcript Display (AC: 2, 3, 4, 7)
  - [x] Create transcript.html template in frontend/templates/
  - [x] Add CSS styling for speaker highlighting и visual separation
  - [x] Implement scrollable transcript display area
  - [x] Add character encoding support for Cyrillic text
  - [x] Create JavaScript for transcript display interactions
- [x] Database Integration and Data Retrieval (AC: 1, 6)
  - [x] Update Job model methods to fetch complete transcript data
  - [x] Join job_results, speakers, and transcript_segments tables
  - [x] Implement proper ordering by segment_order
  - [x] Add database indexes for optimal transcript retrieval performance
  - [x] Create data validation for transcript completeness
- [x] Testing and Quality Assurance (AC: 1-8)
  - [x] Unit tests for TranscriptFormatter service
  - [x] Integration tests for transcript display endpoint
  - [x] Frontend tests for transcript display functionality
  - [x] Character encoding tests for Kazakh/Russian text
  - [x] End-to-end testing with sample transcript data

## Dev Notes

### Previous Story Context

From Story 1.5 completion:

- **Yandex SpeechKit Integration**: Fully implemented с speaker diarization и multi-language support
- **Database Models**: Job, JobResult, Speaker, TranscriptSegment models operational с proper relationships
- **Processing Pipeline**: Complete async processing pipeline с progress tracking
- **API Response Processing**: Yandex API responses parsed и stored in structured database format

### Database Schema Details

[Source: docs/architecture/database-design.md#mvp-schema-sqlite]

**Jobs Table**:

- `job_id` (VARCHAR(36)) - UUID для external reference
- `status` (VARCHAR(20)) - Processing status tracking
- `filename`, `original_filename` - File identification

**JobResults Table**:

- `job_id` (VARCHAR(36)) - Links to jobs table
- `raw_transcript` (TEXT) - Original API response
- `formatted_transcript` (TEXT) - Processed transcript (будет populated by this story)
- `speaker_count` (INTEGER) - Number of detected speakers
- `confidence_score` (FLOAT) - Overall confidence
- `language_detected` (VARCHAR(50)) - Detected language

**Speakers Table**:

- `job_id` (VARCHAR(36)) - Links to jobs table
- `speaker_id` (VARCHAR(20)) - Speaker 1, Speaker 2, etc.
- `speaker_label` (VARCHAR(100)) - User-customizable name
- `speaking_duration` (INTEGER) - Total seconds

**TranscriptSegments Table**:

- `job_id` (VARCHAR(36)) - Links to jobs table
- `speaker_id` (VARCHAR(20)) - Matches speakers.speaker_id
- `start_time` (DECIMAL(10,3)) - Seconds с millisecond precision
- `end_time` (DECIMAL(10,3)) - Segment end time
- `text` (TEXT) - Segment transcript text
- `confidence` (DECIMAL(5,4)) - Segment confidence score
- `segment_order` (INTEGER) - Sequence in transcript

### File Structure Requirements

[Source: docs/architecture/source-tree.md#backend-application-structure]

**Service Layer**:

- `backend/app/services/transcript_formatter.py` - New service для formatting logic
- `backend/app/utils/formatters.py` - Utility functions для text formatting

**Route Layer**:

- `backend/app/routes/jobs.py` - Add transcript endpoint to existing jobs controller
- `backend/app/schemas/job.py` - Add TranscriptResponse schema

**Frontend Structure**:

- `frontend/templates/transcript.html` - New template для transcript display
- `frontend/static/css/results.css` - Styling для transcript display
- `frontend/static/js/transcript.js` - JavaScript functionality

### API Architecture Requirements

[Source: docs/architecture/api-architecture.md#restful-endpoints]

**New Endpoint**:

- `GET /api/v1/jobs/{job_id}/transcript` - Retrieve formatted transcript
- Response format: JSON с transcript data, speaker info, и metadata
- Error handling для missing jobs, incomplete processing

### Character Encoding Standards

[Source: docs/architecture/coding-standards.md#security-standards]

**UTF-8 Support**:

- All text processing must handle UTF-8 encoding
- Proper Cyrillic character support для Kazakh и Russian text
- HTML template meta charset specification
- JavaScript string handling для Unicode text

### Testing Standards

[Source: docs/architecture/coding-standards.md#testing-standards]

**Test Organization**:

- Unit tests: `tests/unit/test_transcript_formatter.py`
- Integration tests: `tests/integration/test_transcript_api.py`
- Frontend tests: Manual testing для character encoding
- Test fixtures: Sample transcript data с Cyrillic text

**Testing Requirements**:

- Mock transcript data с multiple speakers
- Character encoding validation tests
- Timestamp formatting accuracy tests
- HTML template rendering tests
- API response validation tests

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-08-06 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

- All Python files passed syntax validation
- Database migration SQL validated for SQLite compatibility
- Character encoding tests designed for Cyrillic (Russian/Kazakh) support
- Frontend JavaScript includes comprehensive error handling and UTF-8 support

### Completion Notes List

- **TranscriptFormatter Service**: Complete implementation with speaker labeling, timestamp formatting, and text preservation
- **API Endpoints**: Added `/api/v1/jobs/{job_id}/transcript` endpoint with comprehensive error handling and validation
- **Frontend Implementation**: Full responsive transcript display with multiple view modes (full, segments, speakers)
- **Database Optimization**: Added optimized methods to Job model and database indexes for performance
- **Character Encoding**: Full UTF-8 support for Cyrillic text (Russian and Kazakh languages)
- **Testing Suite**: Comprehensive unit, integration, and E2E tests covering all functionality
- **User Experience**: Responsive design, search functionality, copy/download features, accessibility support

### File List

**Backend Files Created/Modified:**

- `backend/app/services/transcript_formatter.py` - New service for transcript formatting
- `backend/app/utils/formatters.py` - New utility functions for text and time formatting
- `backend/app/routes/jobs.py` - Modified to add transcript endpoints
- `backend/app/models/job.py` - Modified to add optimized database methods
- `migrations/add_transcript_indexes.sql` - New database indexes for performance

**Frontend Files Created:**

- `frontend/templates/transcript.html` - New transcript display template
- `frontend/static/css/transcript.css` - New transcript-specific styling
- `frontend/static/js/transcript.js` - New JavaScript for transcript interactions

**Test Files Created:**

- `tests/unit/test_transcript_formatter.py` - Unit tests for formatting service
- `tests/unit/test_character_encoding.py` - Character encoding validation tests
- `tests/integration/test_transcript_api.py` - API endpoint integration tests
- `tests/integration/test_transcript_e2e.py` - End-to-end frontend tests

## QA Results

_Results from QA Agent review will be populated here after implementation_
